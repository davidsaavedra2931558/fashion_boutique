<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - Fashion Boutique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-black: #1a1a1a;
            --secondary-black: #2d2d2d;
            --accent-color: #c8a97e;
            --sale-red: #e74c3c;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 2rem;
        }

        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent-color);
        }

        .total-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--primary-black);
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .input-group-sm {
            width: 120px;
        }

        .invoice-preview {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            margin-top: 2rem;
            border: 1px solid #dee2e6;
        }

        .invoice-header {
            border-bottom: 3px solid var(--primary-black);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        .search-result-card {
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .search-result-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-preview, .invoice-preview * {
                visibility: visible;
            }
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <!-- Punto de Venta Section -->
        <div id="pos" class="content-section">
            <div class="table-container">
                <h2 class="mb-4">Facturación Tienda Física</h2>
                
                <!-- Formulario de búsqueda de productos -->
                <div class="form-section">
                    <h4>Buscar Producto</h4>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="searchProduct" placeholder="Código de barras, nombre o SKU del producto">
                                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                    <i class="fas fa-search me-1"></i> Buscar
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#productModal">
                                <i class="fas fa-plus me-1"></i> Agregar Producto Manualmente
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de productos en la venta -->
                <div class="form-section">
                    <h4>Productos en la Venta</h4>
                    <div class="table-responsive">
                        <table class="table table-striped" id="saleItems">
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Producto</th>
                                    <th>Precio Unit.</th>
                                    <th>Cantidad</th>
                                    <th>Descuento</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los productos se agregarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Resumen de la venta -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-section">
                            <h4>Información del Cliente</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">Nombre del Cliente *</label>
                                        <input type="text" class="form-control" id="customerName" placeholder="Nombre completo" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerId" class="form-label">DNI/NIF/CIF</label>
                                        <input type="text" class="form-control" id="customerId" placeholder="Número de identificación">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="customerEmail" placeholder="correo@ejemplo.com">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerPhone" class="form-label">Teléfono</label>
                                        <input type="tel" class="form-control" id="customerPhone" placeholder="Número de teléfono">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="customerAddress" class="form-label">Dirección</label>
                                <textarea class="form-control" id="customerAddress" rows="2" placeholder="Dirección completa"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="total-section">
                            <h4>Resumen de Venta</h4>
                            <div class="d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Descuento:</span>
                                <span id="totalDiscount">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Impuestos (21%):</span>
                                <span id="taxes">$0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fs-5">
                                <strong>Total:</strong>
                                <strong id="totalAmount">$0.00</strong>
                            </div>
                            
                            <div class="mt-3">
                                <div class="mb-3">
                                    <label for="paymentMethod" class="form-label">Método de Pago</label>
                                    <select class="form-select" id="paymentMethod">
                                        <option value="cash">Efectivo</option>
                                        <option value="card">Tarjeta</option>
                                        <option value="transfer">Transferencia</option>
                                        <option value="digital">Pago Digital</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3" id="cashSection">
                                    <label for="cashAmount" class="form-label">Monto Recibido</label>
                                    <input type="number" class="form-control" id="cashAmount" step="0.01" min="0">
                                    <div class="d-flex justify-content-between mt-2">
                                        <span>Cambio:</span>
                                        <span id="changeAmount">$0.00</span>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success w-100 mt-3" id="completeSale">
                                    <i class="fas fa-check me-1"></i> Completar Venta
                                </button>
                                <button class="btn btn-outline-secondary w-100 mt-2" id="cancelSale">
                                    <i class="fas fa-times me-1"></i> Cancelar Venta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista previa de factura -->
                <div class="invoice-preview" id="invoicePreview" style="display: none;">
                    <h4>Vista Previa de Factura</h4>
                    <div class="invoice-header">
                        <div class="row">
                            <div class="col-md-6">
                                <h3>FACTURA</h3>
                                <p><strong>Nº:</strong> <span id="invoiceNumber">F-2023-001</span></p>
                                <p><strong>Fecha:</strong> <span id="invoiceDate">01/01/2023</span></p>
                            </div>
                            <div class="col-md-6 text-end">
                                <h4>FASHION BOUTIQUE</h4>
                                <p>Calle Principal, 123</p>
                                <p>28001 Madrid, España</p>
                                <p>Tel: +34 91 123 45 67</p>
                                <p>info@fashionboutique.com</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Cliente:</h5>
                            <p id="invoiceCustomerName">-</p>
                            <p id="invoiceCustomerId">-</p>
                            <p id="invoiceCustomerAddress">-</p>
                            <p id="invoiceCustomerContact">-</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <h5>Información de Pago:</h5>
                            <p id="invoicePaymentMethod">-</p>
                            <p id="invoicePaymentDetails">-</p>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio Unit.</th>
                                    <th>Cantidad</th>
                                    <th>Descuento</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <!-- Los productos de la factura se agregarán aquí -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6"></div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotal">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Descuento:</span>
                                <span id="invoiceDiscount">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Impuestos (21%):</span>
                                <span id="invoiceTaxes">$0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fs-5">
                                <strong>Total:</strong>
                                <strong id="invoiceTotal">$0.00</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-primary" id="printInvoice">
                            <i class="fas fa-print me-1"></i> Imprimir Factura
                        </button>
                        <button class="btn btn-success" id="sendInvoice">
                            <i class="fas fa-envelope me-1"></i> Enviar por Email
                        </button>
                        <button class="btn btn-outline-secondary" id="closePreview">
                            <i class="fas fa-times me-1"></i> Cerrar Vista Previa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar producto manualmente -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Agregar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="productName" class="form-label">Nombre del Producto *</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">Precio Unitario *</label>
                        <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="productQuantity" class="form-label">Cantidad *</label>
                        <input type="number" class="form-control" id="productQuantity" min="1" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="productDiscount" class="form-label">Descuento (%)</label>
                        <input type="number" class="form-control" id="productDiscount" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="addProductBtn">Agregar Producto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para resultados de búsqueda -->
    <div class="modal fade" id="searchResultsModal" tabindex="-1" aria-labelledby="searchResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchResultsModalLabel">Resultados de Búsqueda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="searchResults" class="row">
                        <!-- Los resultados se cargarán aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let saleItems = [];
        let invoiceCounter = 1;

        // Elementos del DOM
        const saleItemsTable = document.getElementById('saleItems').getElementsByTagName('tbody')[0];
        const subtotalElement = document.getElementById('subtotal');
        const totalDiscountElement = document.getElementById('totalDiscount');
        const taxesElement = document.getElementById('taxes');
        const totalAmountElement = document.getElementById('totalAmount');
        const cashAmountInput = document.getElementById('cashAmount');
        const changeAmountElement = document.getElementById('changeAmount');
        const invoicePreview = document.getElementById('invoicePreview');
        const cashSection = document.getElementById('cashSection');
        const paymentMethodSelect = document.getElementById('paymentMethod');

        // ==============================================
        // FUNCIONES DE PERSISTENCIA
        // ==============================================

        // Función para guardar la venta actual en localStorage
        function saveSaleToStorage() {
            const saleData = {
                items: saleItems,
                customer: {
                    name: document.getElementById('customerName').value,
                    id: document.getElementById('customerId').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value
                },
                timestamp: new Date().getTime()
            };
            localStorage.setItem('currentSale', JSON.stringify(saleData));
        }

        // Función para cargar la venta desde localStorage
        function loadSaleFromStorage() {
            const savedSale = localStorage.getItem('currentSale');
            if (savedSale) {
                const saleData = JSON.parse(savedSale);
                saleItems = saleData.items || [];
                
                // Restaurar datos del cliente
                if (saleData.customer) {
                    document.getElementById('customerName').value = saleData.customer.name || '';
                    document.getElementById('customerId').value = saleData.customer.id || '';
                    document.getElementById('customerEmail').value = saleData.customer.email || '';
                    document.getElementById('customerPhone').value = saleData.customer.phone || '';
                    document.getElementById('customerAddress').value = saleData.customer.address || '';
                }
                
                updateSaleTable();
                updateTotals();
                console.log('Venta cargada desde almacenamiento:', saleItems.length + ' productos');
            }
        }

        // Función para limpiar el almacenamiento
        function clearSaleStorage() {
            localStorage.removeItem('currentSale');
            console.log('Almacenamiento limpiado');
        }

        // ==============================================
        // FUNCIONES PRINCIPALES (MODIFICADAS)
        // ==============================================

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar venta guardada al iniciar
            loadSaleFromStorage();
            
            // Mostrar/ocultar sección de efectivo según método de pago
            paymentMethodSelect.addEventListener('change', function() {
                cashSection.style.display = this.value === 'cash' ? 'block' : 'none';
            });
            
            // Calcular cambio cuando se ingresa monto en efectivo
            cashAmountInput.addEventListener('input', calculateChange);
            
            // Botón para agregar producto manualmente
            document.getElementById('addProductBtn').addEventListener('click', addManualProduct);
            
            // Botón para buscar productos
            document.getElementById('searchBtn').addEventListener('click', searchProducts);
            
            // Buscar al presionar Enter
            document.getElementById('searchProduct').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchProducts();
                }
            });
            
            // Botón para completar venta
            document.getElementById('completeSale').addEventListener('click', completeSale);
            
            // Botón para cancelar venta
            document.getElementById('cancelSale').addEventListener('click', cancelSale);
            
            // Botones de la vista previa de factura
            document.getElementById('printInvoice').addEventListener('click', printInvoice);
            document.getElementById('sendInvoice').addEventListener('click', sendInvoice);
            document.getElementById('closePreview').addEventListener('click', closeInvoicePreview);
            
            // Guardar datos del cliente cuando cambien
            document.getElementById('customerName').addEventListener('input', saveSaleToStorage);
            document.getElementById('customerId').addEventListener('input', saveSaleToStorage);
            document.getElementById('customerEmail').addEventListener('input', saveSaleToStorage);
            document.getElementById('customerPhone').addEventListener('input', saveSaleToStorage);
            document.getElementById('customerAddress').addEventListener('input', saveSaleToStorage);
            
            // Inicializar con método de pago en efectivo
            cashSection.style.display = 'block';
        });

        // Función para mostrar notificaciones
        function showNotification(message, type = 'success') {
            // Eliminar notificaciones anteriores
            const existingNotifications = document.querySelectorAll('.alert-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-notification alert-dismissible fade show`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto-eliminar después de 4 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        // Función para agregar producto manualmente
        function addManualProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const discount = parseFloat(document.getElementById('productDiscount').value);
            
            if (!name || isNaN(price) || isNaN(quantity)) {
                showNotification('Por favor, complete todos los campos obligatorios', 'warning');
                return;
            }
            
            if (price <= 0) {
                showNotification('El precio debe ser mayor a 0', 'warning');
                return;
            }
            
            addProductToSale({
                id: Date.now(), // ID temporal
                name: name,
                price: price,
                quantity: quantity,
                discount: discount
            });
            
            // Cerrar modal automáticamente
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();
            
            // Limpiar campos
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productQuantity').value = '1';
            document.getElementById('productDiscount').value = '0';
            
            showNotification('Producto agregado correctamente', 'success');
        }

        // Función para buscar productos
        async function searchProducts() {
            const searchTerm = document.getElementById('searchProduct').value.trim();
            
            if (!searchTerm) {
                showNotification('Por favor, ingrese un término de búsqueda', 'warning');
                return;
            }
            
            try {
                // Mostrar loading
                document.getElementById('searchResults').innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Buscando...</span>
                        </div>
                        <p class="mt-2">Buscando productos...</p>
                    </div>
                `;
                
                // Llamar a la API para buscar productos
                const response = await fetch(`/api/products/search?q=${encodeURIComponent(searchTerm)}`);
                const products = await response.json();
                
                displaySearchResults(products);
                
            } catch (error) {
                console.error('Error buscando productos:', error);
                document.getElementById('searchResults').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">Error al buscar productos</div>
                    </div>
                `;
            }
        }

        // Función para mostrar resultados de búsqueda
        function displaySearchResults(products) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (products.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No se encontraron productos</p>
                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#productModal">
                            <i class="fas fa-plus me-1"></i> Agregar Producto Manualmente
                        </button>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = products.map(product => `
                    <div class="col-md-6 mb-3">
                        <div class="card search-result-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${product.nameProduct || product.name}</h6>
                                <p class="card-text mb-2">
                                    <strong>Precio:</strong> $${(product.price || 0).toFixed(2)}<br>
                                    <strong>Stock:</strong> ${product.stock || 'N/A'}<br>
                                    ${product.sku ? `<strong>SKU:</strong> ${product.sku}` : ''}
                                    ${product.category ? `<br><strong>Categoría:</strong> ${product.category}` : ''}
                                </p>
                                <button class="btn btn-success btn-sm" onclick="addSearchedProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-cart-plus me-1"></i> Agregar a Venta
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Mostrar modal con resultados
            const searchModal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
            searchModal.show();
        }

        // Función para agregar producto desde búsqueda
        function addSearchedProduct(product) {
            addProductToSale({
                id: product.idProduct || product.id,
                name: product.nameProduct || product.name,
                price: product.price || 0,
                quantity: 1,
                discount: 0
            });
            
            // Cerrar modal de búsqueda
            bootstrap.Modal.getInstance(document.getElementById('searchResultsModal')).hide();
            
            // Limpiar campo de búsqueda
            document.getElementById('searchProduct').value = '';
            
            showNotification('Producto agregado a la venta', 'success');
        }

        // Función para agregar producto a la venta (MODIFICADA CON PERSISTENCIA)
        function addProductToSale(product) {
            // Verificar si el producto ya está en la venta
            const existingItemIndex = saleItems.findIndex(item => item.id === product.id);
            
            if (existingItemIndex !== -1) {
                // Si ya existe, aumentar la cantidad
                saleItems[existingItemIndex].quantity += product.quantity;
            } else {
                // Si no existe, agregarlo
                saleItems.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: product.quantity,
                    discount: product.discount || 0
                });
            }
            
            updateSaleTable();
            updateTotals();
            saveSaleToStorage(); // ← GUARDAR EN STORAGE
        }

        // Función para actualizar la tabla de productos en venta
        function updateSaleTable() {
            saleItemsTable.innerHTML = '';
            
            saleItems.forEach((item, index) => {
                const discountAmount = (item.price * item.quantity * item.discount) / 100;
                const subtotal = (item.price * item.quantity) - discountAmount;
                
                const row = saleItemsTable.insertRow();
                row.innerHTML = `
                    <td><img src="https://via.placeholder.com/80/007bff/ffffff?text=P" alt="${item.name}" class="product-image"></td>
                    <td>${item.name}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${index}, -1)">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" min="1" onchange="updateQuantityInput(${index}, this.value)">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>${item.discount}%</td>
                    <td>$${subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        // Función para actualizar cantidad mediante botones (MODIFICADA CON PERSISTENCIA)
        function updateQuantity(index, change) {
            saleItems[index].quantity += change;
            
            if (saleItems[index].quantity < 1) {
                saleItems[index].quantity = 1;
            }
            
            updateSaleTable();
            updateTotals();
            saveSaleToStorage(); // ← GUARDAR EN STORAGE
        }

        // Función para actualizar cantidad mediante input (MODIFICADA CON PERSISTENCIA)
        function updateQuantityInput(index, value) {
            const quantity = parseInt(value);
            
            if (isNaN(quantity) || quantity < 1) {
                saleItems[index].quantity = 1;
            } else {
                saleItems[index].quantity = quantity;
            }
            
            updateSaleTable();
            updateTotals();
            saveSaleToStorage(); // ← GUARDAR EN STORAGE
        }

        // Función para eliminar producto (MODIFICADA CON PERSISTENCIA)
        function removeProduct(index) {
            saleItems.splice(index, 1);
            updateSaleTable();
            updateTotals();
            saveSaleToStorage(); // ← GUARDAR EN STORAGE
            showNotification('Producto eliminado', 'info');
        }

        // Función para actualizar totales
        function updateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            
            saleItems.forEach(item => {
                const itemSubtotal = item.price * item.quantity;
                const itemDiscount = (itemSubtotal * item.discount) / 100;
                subtotal += itemSubtotal;
                totalDiscount += itemDiscount;
            });
            
            const netSubtotal = subtotal - totalDiscount;
            const taxes = netSubtotal * 0.21; // 21% de IVA
            const total = netSubtotal + taxes;
            
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            totalDiscountElement.textContent = `$${totalDiscount.toFixed(2)}`;
            taxesElement.textContent = `$${taxes.toFixed(2)}`;
            totalAmountElement.textContent = `$${total.toFixed(2)}`;
            
            // Recalcular cambio si hay monto en efectivo
            calculateChange();
        }

        // Función para calcular cambio
        function calculateChange() {
            const total = parseFloat(totalAmountElement.textContent.replace('$', ''));
            const cashAmount = parseFloat(cashAmountInput.value) || 0;
            const change = cashAmount - total;
            
            changeAmountElement.textContent = `$${change >= 0 ? change.toFixed(2) : '0.00'}`;
            changeAmountElement.style.color = change >= 0 ? 'green' : 'red';
        }

        // Función para completar la venta (MODIFICADA CON PERSISTENCIA)
        function completeSale() {
            if (saleItems.length === 0) {
                showNotification('No hay productos en la venta', 'warning');
                return;
            }
            
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                showNotification('Por favor, ingrese el nombre del cliente', 'warning');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            if (paymentMethod === 'cash') {
                const cashAmount = parseFloat(cashAmountInput.value) || 0;
                const total = parseFloat(totalAmountElement.textContent.replace('$', ''));
                
                if (cashAmount < total) {
                    showNotification('El monto en efectivo es menor al total de la venta', 'warning');
                    return;
                }
            }
            
            // Generar factura
            generateInvoice();
            
            // Mostrar vista previa
            invoicePreview.style.display = 'block';
            
            // Desplazarse a la factura
            invoicePreview.scrollIntoView({ behavior: 'smooth' });
            
            // LIMPIAR ALMACENAMIENTO SOLO DESPUÉS DE COMPLETAR
            setTimeout(() => {
                clearSaleStorage();
            }, 1000);
            
            showNotification('Venta completada correctamente', 'success');
        }

        // Función para generar factura
        function generateInvoice() {
            // Actualizar número y fecha de factura
            const now = new Date();
            document.getElementById('invoiceNumber').textContent = `F-${now.getFullYear()}-${invoiceCounter.toString().padStart(3, '0')}`;
            document.getElementById('invoiceDate').textContent = now.toLocaleDateString('es-ES');
            
            // Actualizar información del cliente
            document.getElementById('invoiceCustomerName').textContent = document.getElementById('customerName').value;
            document.getElementById('invoiceCustomerId').textContent = document.getElementById('customerId').value || '-';
            document.getElementById('invoiceCustomerAddress').textContent = document.getElementById('customerAddress').value || '-';
            
            const email = document.getElementById('customerEmail').value;
            const phone = document.getElementById('customerPhone').value;
            document.getElementById('invoiceCustomerContact').textContent = 
                `${email ? email + ' | ' : ''}${phone || ''}`;
            
            // Actualizar información de pago
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentText = {
                'cash': 'Efectivo',
                'card': 'Tarjeta',
                'transfer': 'Transferencia',
                'digital': 'Pago Digital'
            }[paymentMethod];
            
            document.getElementById('invoicePaymentMethod').textContent = `Método: ${paymentText}`;
            
            if (paymentMethod === 'cash') {
                const cashAmount = parseFloat(cashAmountInput.value) || 0;
                const change = parseFloat(changeAmountElement.textContent.replace('$', ''));
                document.getElementById('invoicePaymentDetails').textContent = 
                    `Recibido: $${cashAmount.toFixed(2)} | Cambio: $${change.toFixed(2)}`;
            } else {
                document.getElementById('invoicePaymentDetails').textContent = '';
            }
            
            // Actualizar productos en la factura
            const invoiceItemsTable = document.getElementById('invoiceItems');
            invoiceItemsTable.innerHTML = '';
            
            let subtotal = 0;
            let totalDiscount = 0;
            
            saleItems.forEach(item => {
                const itemSubtotal = item.price * item.quantity;
                const itemDiscount = (itemSubtotal * item.discount) / 100;
                const itemTotal = itemSubtotal - itemDiscount;
                
                subtotal += itemSubtotal;
                totalDiscount += itemDiscount;
                
                const row = invoiceItemsTable.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>${item.discount}% ($${itemDiscount.toFixed(2)})</td>
                    <td>$${itemTotal.toFixed(2)}</td>
                `;
            });
            
            const netSubtotal = subtotal - totalDiscount;
            const taxes = netSubtotal * 0.21;
            const total = netSubtotal + taxes;
            
            document.getElementById('invoiceSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('invoiceDiscount').textContent = `$${totalDiscount.toFixed(2)}`;
            document.getElementById('invoiceTaxes').textContent = `$${taxes.toFixed(2)}`;
            document.getElementById('invoiceTotal').textContent = `$${total.toFixed(2)}`;
            
            // Incrementar contador de facturas
            invoiceCounter++;
        }

        // Función para cancelar venta (MODIFICADA CON PERSISTENCIA)
        function cancelSale() {
            if (confirm('¿Está seguro de que desea cancelar la venta? Se perderán todos los datos.')) {
                saleItems = [];
                updateSaleTable();
                updateTotals();
                
                // Limpiar formulario
                document.getElementById('customerName').value = '';
                document.getElementById('customerId').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('cashAmount').value = '';
                document.getElementById('paymentMethod').value = 'cash';
                cashSection.style.display = 'block';
                
                // Ocultar vista previa si está visible
                invoicePreview.style.display = 'none';
                
                // LIMPIAR ALMACENAMIENTO
                clearSaleStorage();
                
                showNotification('Venta cancelada', 'info');
            }
        }

        // Función para imprimir factura
        function printInvoice() {
            window.print();
        }

        // Función para enviar factura por email
        async function sendInvoice() {
            const customerEmail = document.getElementById('customerEmail').value;
            
            if (!customerEmail) {
                showNotification('No se ha proporcionado un email para enviar la factura', 'warning');
                return;
            }
            
            try {
                // Preparar datos de la factura
                const invoiceData = {
                    invoice_number: document.getElementById('invoiceNumber').textContent,
                    customer_name: document.getElementById('customerName').value,
                    customer_id: document.getElementById('customerId').value,
                    customer_email: customerEmail,
                    customer_phone: document.getElementById('customerPhone').value,
                    customer_address: document.getElementById('customerAddress').value,
                    payment_method: document.getElementById('paymentMethod').options[document.getElementById('paymentMethod').selectedIndex].text,
                    payment_details: document.getElementById('invoicePaymentDetails').textContent,
                    items: saleItems.map(item => ({
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        discount: item.discount,
                        subtotal: (item.price * item.quantity) - ((item.price * item.quantity * item.discount) / 100)
                    })),
                    subtotal: parseFloat(document.getElementById('invoiceSubtotal').textContent.replace('$', '')),
                    total_discount: parseFloat(document.getElementById('invoiceDiscount').textContent.replace('$', '')),
                    taxes: parseFloat(document.getElementById('invoiceTaxes').textContent.replace('$', '')),
                    total: parseFloat(document.getElementById('invoiceTotal').textContent.replace('$', ''))
                };
                
                // Enviar al servidor
                const response = await fetch('/send_invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(invoiceData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Factura enviada correctamente a ${customerEmail}`, 'success');
                } else {
                    showNotification('Error enviando la factura: ' + result.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error enviando la factura', 'danger');
            }
        }

        // Función para cerrar vista previa
        function closeInvoicePreview() {
            invoicePreview.style.display = 'none';
            
            // Reiniciar la venta después de completarla
            setTimeout(() => {
                cancelSale();
            }, 500);
        }
    </script>
</body>
</html>